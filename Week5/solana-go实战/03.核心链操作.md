# 核心链操作实战教程

## 1. 区块数据查询
```go
package main

import (
    "context"
    "fmt"
    "github.com/portto/solana-go-sdk/client"
    "github.com/portto/solana-go-sdk/rpc"
)

func main() {
    // 创建RPC客户端（连接到DevNet）
    c := client.NewClient(rpc.DevnetRPCEndpoint)
    
    // 获取最新区块
    recentBlock, err := c.GetBlock(context.Background(), 0) // 0表示最新区块
    if err != nil {
        panic("查询失败: " + err.Error())
    }
    
    fmt.Printf("区块高度: %d\n", recentBlock.BlockHeight)
    fmt.Printf("交易数量: %d\n", len(recentBlock.Transactions))
}
```

## 2. 交易全流程
```go
package main

import (
    "context"
    "fmt"
    "github.com/portto/solana-go-sdk/client"
    "github.com/portto/solana-go-sdk/rpc"
    "github.com/portto/solana-go-sdk/system"
    "github.com/portto/solana-go-sdk/types"
)

func main() {
    c := client.NewClient(rpc.DevnetRPCEndpoint)
    
    // 生成发送方密钥对（实际项目应从钱包加载）
    payer := types.NewAccount()
    
    // 获取最新区块哈希
    recentBlockhash, _ := c.GetRecentBlockhash(context.Background())
    
    // 创建转账指令（向随机地址转账0.01 SOL）
    instruction := system.NewTransferInstruction(
        1_000_000, // 0.01 SOL (lamport单位)
        payer.PublicKey,
        types.NewAccount().PublicKey,
    )
    
    // 构建交易
    tx, _ := types.NewTransaction(
        types.NewTransactionParam{
            Instructions: []types.Instruction{instruction},
            Signers:      []types.Account{payer},
            RecentBlockHash: recentBlockhash.Blockhash,
            FeePayer:     payer.PublicKey,
        },
    )
    
    // 发送交易
    sig, _ := c.SendTransactionWithConfig(
        context.Background(),
        tx,
        rpc.SendTransactionConfig{
            Encoding: rpc.TransactionEncodingBase64,
        },
    )
    
    fmt.Printf("交易已提交，哈希: %s\n", sig)
}
```

## 3. 合约部署实战
```bash
# 生成Go绑定（假设已安装solana-program-cli）
abigen --program-id TOKEN_PROGRAM_ID --pkg token --out token_program.go
```

```go
package main

import (
    "context"
    "github.com/portto/solana-go-sdk/client"
    "github.com/portto/solana-go-sdk/rpc"
    "os"
)

func deployTokenProgram() string {
    c := client.NewClient(rpc.DevnetRPCEndpoint)
    
    // 加载编译后的程序文件
    programBin, _ := os.ReadFile("spl_token.so")
    
    // 部署交易
    txHash, _ := c.DeployProgramWithOpts(
        context.Background(),
        programBin,
        rpc.DeployProgramOpts{
            SkipPreflight:  false,
            PreflightCommitment: rpc.CommitmentFinalized,
        },
    )
    
    return txHash
}
```

## 4. 错误处理模板
```go
// 交易超时处理
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()

// 余额不足检测
if balance < requiredAmount + minBalanceForRentExemption {
    return errors.New("账户余额不足，需要额外支付租金")
}

// 区块哈希过期重试
if err.Error().Contains("Blockhash not found") {
    recentBlockhash, _ = c.GetRecentBlockhash(context.Background())
    // 重新发送交易...
}
```

## 5. 测试验证脚本
```bash
# 查询部署结果
solana confirm -v ${TX_HASH} --url devnet

# 检查程序账户
solana program show ${PROGRAM_ID} --url devnet
```
